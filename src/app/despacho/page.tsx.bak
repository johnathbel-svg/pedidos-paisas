"use client";

import * as React from "react";
import { supabase } from "@/lib/supabase";
import { Order } from "@/types/order";
import { Clock, CheckCircle2, Truck, DollarSign } from "lucide-react";
import { cn } from "@/lib/utils";

export default function DespachoPage() {
    const [orders, setOrders] = React.useState<Order[]>([]);
    const [loading, setLoading] = React.useState(true);

    const fetchOrders = async () => {
        const { data, error } = await supabase
            .from('orders')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50);

        if (error) console.error("Error fetching orders:", error);
        else setOrders(data as Order[] || []);
        setLoading(false);
    };

    React.useEffect(() => {
        fetchOrders();

        // Subscribe to realtime changes
        const channel = supabase
            .channel('realtime orders')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
                console.log('Change received!', payload);
                // Optimistic update or simple refetch
                fetchOrders();
            })
            .subscribe();

        return () => {
            supabase.removeChannel(channel);
        };
    }, []);

    const updateStatus = async (id: string, newStatus: Order['status']) => {
        const { error } = await supabase
            .from('orders')
            .update({ status: newStatus })
            .eq('id', id);

        if (error) alert("Error updating status");
        // Interface will update via realtime subscription
    };

    if (loading) return <div className="p-8">Cargando pedidos...</div>;

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold tracking-tight">Tablero de Despacho</h2>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {orders.map((order) => {
                    let statusColor = "bg-slate-500";
                    if (order.status === 'TOMADO') statusColor = "bg-blue-500";
                    if (order.status === 'DESPACHO') statusColor = "bg-orange-500";
                    if (order.status === 'ENTREGADO') statusColor = "bg-green-500";
                    if (order.status === 'PAGADO') statusColor = "bg-gray-500";

                    return (
                        <div key={order.id} className="rounded-lg border bg-card text-card-foreground shadow-sm overflow-hidden flex flex-col">
                            <div className={cn("h-2 w-full", statusColor)} />
                            <div className="p-6">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <span className="text-xs font-mono bg-muted px-1.5 py-0.5 rounded">{order.public_id}</span>
                                        <h3 className="text-lg font-bold mt-1">{order.client_name || "Cliente General"}</h3>
                                    </div>
                                    <span className={cn("text-xs font-semibold px-2 py-1 rounded-full text-white", statusColor)}>
                                        {order.status}
                                    </span>
                                </div>

                                <div className="space-y-2 text-sm text-muted-foreground mb-4">
                                    <div className="flex items-center gap-2">
                                        <DollarSign className="h-4 w-4" />
                                        <span className="text-foreground font-medium">${order.total_value?.toLocaleString()}</span>
                                    </div>
                                    {order.observations && (
                                        <p className="italic border-l-2 pl-2 border-muted">"{order.observations}"</p>
                                    )}
                                    <div className="flex items-center gap-2 text-xs">
                                        <Clock className="h-3 w-3" />
                                        {new Date(order.created_at).toLocaleTimeString()}
                                    </div>
                                </div>

                                <div className="flex gap-2 mt-auto pt-4 border-t">
                                    {order.status === 'TOMADO' && (
                                        <button
                                            onClick={() => updateStatus(order.id, 'DESPACHO')}
                                            className="flex-1 bg-orange-500 hover:bg-orange-600 text-white rounded px-3 py-2 text-sm font-medium transition-colors"
                                        >
                                            <Truck className="inline-block mr-1 h-4 w-4" /> A Despacho
                                        </button>
                                    )}
                                    {order.status === 'DESPACHO' && (
                                        <button
                                            onClick={() => updateStatus(order.id, 'ENTREGADO')}
                                            className="flex-1 bg-green-500 hover:bg-green-600 text-white rounded px-3 py-2 text-sm font-medium transition-colors"
                                        >
                                            <CheckCircle2 className="inline-block mr-1 h-4 w-4" /> Marcar Entregado
                                        </button>
                                    )}
                                    {/* More logic can be added here */}
                                </div>
                            </div>
                        </div>
                    );
                })}

                {orders.length === 0 && (
                    <div className="col-span-full text-center py-12 text-muted-foreground border-2 border-dashed rounded-lg">
                        No hay pedidos activos por el momento.
                    </div>
                )}
            </div>
        </div>
    );
}
